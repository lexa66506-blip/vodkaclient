<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Marketplace - VodkaClient</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
}

.floating-nav {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 12px 25px;
    background: rgba(20, 20, 20, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(80, 80, 80, 0.25);
    border-radius: 10px;
}

.nav-logo { font-size: 18px; font-weight: 700; color: #888; margin-right: 15px; }
.nav-links { display: flex; gap: 4px; }
.nav-links a { color: rgba(255,255,255,0.5); text-decoration: none; font-size: 13px; padding: 8px 14px; border-radius: 10px; transition: all 0.3s; }
.nav-links a:hover { color: #fff; background: rgba(80,80,80,0.2); }
.nav-links a.active { color: #fff; background: rgba(80,80,80,0.3); }
.nav-user { display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #3a3a3a, #555); padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; margin-left: 15px; cursor: pointer; text-decoration: none; color: #fff; }
</style>
</head>
<body>

<nav class="floating-nav">
    <div class="nav-logo">VodkaClient</div>
    <div class="nav-links">
        <a href="/">üè† Home</a>
        <a href="/marketplace.html" class="active">üõí Marketplace</a>
        <a href="https://t.me/SmertnixVteste" target="_blank">üí¨ Support</a>
    </div>
    <a href="/cabinet.html" class="nav-user">
        <span>üë§</span>
        <span id="navUsername">username</span>
    </a>
</nav>

<style>
.main-container { position: relative; z-index: 10; display: flex; min-height: 100vh; padding: 100px 30px 30px; }

.sidebar { position: fixed; left: 0; top: 50%; transform: translateY(-50%); z-index: 99; display: flex; align-items: center; }
.sidebar-toggle { width: 28px; height: 70px; background: rgba(20,20,20,0.85); backdrop-filter: blur(20px); border: 1px solid rgba(80,80,80,0.25); border-left: none; border-radius: 0 12px 12px 0; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; font-size: 20px; transition: all 0.3s; }
.sidebar-toggle:hover { background: rgba(30,30,30,0.9); color: #fff; }
.sidebar.open .sidebar-toggle { border-radius: 0; }
.sidebar-content { width: 0; height: 400px; background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(80,80,80,0.25); border-left: none; border-radius: 0 12px 12px 0; overflow: hidden; transition: width 0.3s ease; display: flex; flex-direction: column; }
.sidebar.open .sidebar-content { width: 220px; padding: 20px 15px; }
.sidebar-header { font-size: 16px; font-weight: 600; color: #fff; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid rgba(80,80,80,0.3); opacity: 0; transition: opacity 0.2s; }
.sidebar.open .sidebar-header { opacity: 1; }
.sidebar-menu { display: flex; flex-direction: column; gap: 6px; opacity: 0; transition: opacity 0.2s; }
.sidebar.open .sidebar-menu { opacity: 1; }
.sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: rgba(40,40,40,0.5); border: 1px solid rgba(80,80,80,0.2); border-radius: 10px; color: #888; font-size: 13px; cursor: pointer; transition: all 0.2s; }
.sidebar-item:hover { background: rgba(60,60,60,0.5); color: #fff; }
.sidebar-item.active { background: rgba(80,80,80,0.4); border-color: rgba(100,100,100,0.4); color: #fff; }
.sidebar-item span { font-size: 16px; }

.content-wrapper { flex: 1; display: flex; justify-content: center; padding-left: 50px; }
.content-panel { width: 100%; max-width: 900px; background: rgba(25,25,25,0.85); border: 1px solid rgba(80,80,80,0.25); border-radius: 12px; backdrop-filter: blur(15px); overflow: hidden; }
.content-header { padding: 25px 30px; border-bottom: 1px solid rgba(80,80,80,0.2); display: flex; justify-content: space-between; align-items: center; }
.content-title { font-size: 22px; font-weight: 600; color: #fff; }
.search-box { display: flex; gap: 10px; }
.search-input { width: 280px; padding: 10px 15px; background: rgba(15,15,15,0.9); border: 1px solid rgba(80,80,80,0.3); border-radius: 10px; color: #fff; font-size: 13px; }
.search-input:focus { outline: none; border-color: #666; }
.search-btn { padding: 10px 20px; background: rgba(80,80,80,0.3); border: 1px solid rgba(80,80,80,0.3); border-radius: 10px; color: #aaa; font-size: 13px; cursor: pointer; transition: all 0.2s; }
.search-btn:hover { background: rgba(100,100,100,0.4); color: #fff; }
.content-body { padding: 25px 30px; min-height: 400px; }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

.configs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
.config-card { background: rgba(30,30,30,0.8); border: 1px solid rgba(80,80,80,0.25); border-radius: 10px; padding: 18px; transition: all 0.2s; }
.config-card:hover { background: rgba(40,40,40,0.8); border-color: rgba(100,100,100,0.3); transform: translateY(-2px); }
.config-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.config-name { font-size: 15px; font-weight: 600; color: #fff; }
.config-badge { padding: 3px 8px; background: rgba(80,80,80,0.3); border-radius: 6px; font-size: 10px; color: #888; }
.config-badge.private { background: rgba(255,100,100,0.2); color: #ff8888; }
.config-author { font-size: 12px; color: #666; margin-bottom: 10px; }
.config-desc { font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.4; }
.config-actions { display: flex; gap: 8px; }
.config-btn { flex: 1; padding: 8px 12px; background: rgba(80,80,80,0.2); border: 1px solid rgba(80,80,80,0.3); border-radius: 8px; color: #aaa; font-size: 12px; cursor: pointer; transition: all 0.2s; }
.config-btn:hover { background: rgba(100,100,100,0.3); color: #fff; }
.config-btn.primary { background: rgba(100,100,100,0.3); color: #fff; }
.config-btn.delete { background: rgba(255,50,50,0.2); border-color: rgba(255,50,50,0.3); color: #ff6b6b; }
.config-btn.delete:hover { background: rgba(255,50,50,0.3); }
.config-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.empty-state { text-align: center; padding: 60px 20px; color: #555; }
.empty-state-icon { font-size: 48px; margin-bottom: 15px; }
.empty-state-text { font-size: 14px; margin-bottom: 20px; }
.upload-btn { padding: 12px 25px; background: rgba(80,80,80,0.3); border: 1px dashed rgba(80,80,80,0.5); border-radius: 10px; color: #888; font-size: 13px; cursor: pointer; transition: all 0.2s; }
.upload-btn:hover { background: rgba(100,100,100,0.3); color: #aaa; }
</style>

<style>
.sidebar-item.upload-sidebar-btn { background: rgba(80,80,80,0.3); border-color: rgba(100,100,100,0.3); }
.sidebar-item.upload-sidebar-btn:hover { background: rgba(100,100,100,0.4); }

.upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
.upload-modal.active { display: flex; }
.upload-modal-content { width: 90%; max-width: 600px; height: 400px; background: rgba(25,25,25,0.98); border: 1px solid rgba(80,80,80,0.4); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
.upload-modal-header { padding: 20px 25px; border-bottom: 1px solid rgba(80,80,80,0.3); display: flex; justify-content: space-between; align-items: center; }
.upload-modal-title { font-size: 18px; font-weight: 600; color: #fff; }
.upload-modal-close { width: 32px; height: 32px; background: rgba(80,80,80,0.3); border: none; border-radius: 8px; color: #888; font-size: 18px; cursor: pointer; transition: all 0.2s; }
.upload-modal-close:hover { background: rgba(255,80,80,0.3); color: #ff8888; }
.upload-dropzone { flex: 1; margin: 25px; border: 2px dashed rgba(80,80,80,0.5); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; transition: all 0.3s; cursor: pointer; }
.upload-dropzone:hover { border-color: rgba(120,120,120,0.6); background: rgba(40,40,40,0.3); }
.upload-dropzone.dragover { border-color: rgba(100,200,100,0.6); background: rgba(100,200,100,0.1); }
.upload-dropzone-icon { font-size: 64px; color: #555; }
.upload-dropzone-text { font-size: 16px; color: #888; }
.upload-dropzone-hint { font-size: 12px; color: #555; }
.upload-dropzone input[type="file"] { display: none; }
.upload-progress { display: none; flex-direction: column; align-items: center; gap: 15px; }
.upload-progress.active { display: flex; }
.upload-progress-bar { width: 200px; height: 6px; background: rgba(80,80,80,0.3); border-radius: 3px; overflow: hidden; }
.upload-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #666, #888); border-radius: 3px; transition: width 0.3s; }
.upload-form { display: none; padding: 25px; flex-direction: column; gap: 15px; }
.upload-form.active { display: flex; }
.upload-form-row { display: flex; flex-direction: column; gap: 6px; }
.upload-form-label { font-size: 12px; color: #888; }
.upload-form-input { padding: 12px 15px; background: rgba(15,15,15,0.9); border: 1px solid rgba(80,80,80,0.3); border-radius: 10px; color: #fff; font-size: 14px; }
.upload-form-input:focus { outline: none; border-color: #666; }
.upload-form-textarea { padding: 12px 15px; background: rgba(15,15,15,0.9); border: 1px solid rgba(80,80,80,0.3); border-radius: 10px; color: #fff; font-size: 14px; resize: none; height: 80px; }
.upload-form-checkbox { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #888; cursor: pointer; }
.upload-form-checkbox input { width: 18px; height: 18px; cursor: pointer; }
.upload-form-actions { display: flex; gap: 10px; margin-top: 10px; }
.upload-form-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
.upload-form-btn.cancel { background: transparent; border: 1px solid rgba(80,80,80,0.4); color: #888; }
.upload-form-btn.submit { background: rgba(80,80,80,0.4); border: 1px solid rgba(100,100,100,0.4); color: #fff; }
.upload-form-btn:hover { background: rgba(100,100,100,0.4); }
.no-sub-msg { color: #ff6b6b; font-size: 11px; margin-top: 5px; }
</style>

<div class="sidebar" id="sidebar">
    <div class="sidebar-content">
        <div class="sidebar-header">üì¶ –ú–µ–Ω—é</div>
        <div class="sidebar-menu">
            <div class="sidebar-item active" data-tab="search"><span>üè†</span> –ì–ª–∞–≤–Ω–∞—è</div>
            <div class="sidebar-item" data-tab="my-configs"><span>üìÅ</span> –ú–æ–∏ –∫–æ–Ω—Ñ–∏–≥–∏</div>
            <div class="sidebar-item" data-tab="private"><span>üîí</span> –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏</div>
            <div class="sidebar-item" data-tab="media"><span>üé¨</span> –û—Ç Media</div>
            <div class="sidebar-item upload-sidebar-btn" id="uploadSidebarBtn"><span>üì§</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
        </div>
    </div>
    <div class="sidebar-toggle" id="sidebarToggle">‚Ä∫</div>
</div>

<div class="main-container">
    <div class="content-wrapper">
        <div class="content-panel">
            
            <div class="tab-panel active" id="tab-search">
                <div class="content-header">
                    <div class="content-title">üè† –ì–ª–∞–≤–Ω–∞—è</div>
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∞–≤—Ç–æ—Ä...">
                        <button class="search-btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
                    </div>
                </div>
                <div class="content-body">
                    <div class="empty-state" id="searchEmpty">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Marketplace!</div>
                    </div>
                    <div class="configs-grid" id="searchResults" style="display: none;"></div>
                </div>
            </div>

            <div class="tab-panel" id="tab-my-configs">
                <div class="content-header">
                    <div class="content-title">üìÅ –ú–æ–∏ –∫–æ–Ω—Ñ–∏–≥–∏</div>
                    <button class="upload-btn" id="uploadBtn">+ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>
                </div>
                <div class="content-body">
                    <div class="empty-state" id="myConfigsEmpty">
                        <div class="empty-state-icon">üìÇ</div>
                        <div class="empty-state-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤</div>
                        <button class="upload-btn" id="uploadBtn2">+ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ñ–∏–≥</button>
                    </div>
                    <div class="configs-grid" id="myConfigsGrid" style="display: none;"></div>
                </div>
            </div>

            <div class="tab-panel" id="tab-private">
                <div class="content-header">
                    <div class="content-title">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏</div>
                </div>
                <div class="content-body">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîê</div>
                        <div class="empty-state-text">–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–∞–º</div>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="tab-media">
                <div class="content-header">
                    <div class="content-title">üé¨ –ö–æ–Ω—Ñ–∏–≥–∏ –æ—Ç Media</div>
                </div>
                <div class="content-body">
                    <div class="empty-state" id="mediaEmpty">
                        <div class="empty-state-icon">üé¨</div>
                        <div class="empty-state-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="configs-grid" id="mediaConfigsGrid" style="display: none;"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="upload-modal" id="uploadModal">
    <div class="upload-modal-content">
        <div class="upload-modal-header">
            <div class="upload-modal-title">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</div>
            <button class="upload-modal-close" id="uploadModalClose">‚úï</button>
        </div>
        <div class="upload-dropzone" id="uploadDropzone">
            <div class="upload-dropzone-icon">üìÅ</div>
            <div class="upload-dropzone-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ —Å—é–¥–∞</div>
            <div class="upload-dropzone-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ (.json, .cfg, .txt)</div>
            <input type="file" id="fileInput" accept=".json,.cfg,.txt,.yaml,.yml">
            <div class="upload-progress" id="uploadProgress">
                <div class="upload-progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="upload-progress-bar"><div class="upload-progress-fill" id="uploadProgressFill"></div></div>
            </div>
        </div>
        <div class="upload-form" id="uploadForm">
            <div class="upload-form-row">
                <label class="upload-form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞</label>
                <input type="text" class="upload-form-input" id="configName" placeholder="–ú–æ–π –∫—Ä—É—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥">
            </div>
            <div class="upload-form-row">
                <label class="upload-form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="upload-form-textarea" id="configDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞..."></textarea>
            </div>
            <label class="upload-form-checkbox">
                <input type="checkbox" id="configPrivate">
                –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—è)
            </label>
            <div class="upload-form-actions">
                <button class="upload-form-btn cancel" id="uploadCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="upload-form-btn submit" id="uploadSubmit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let userData = null;
let hasSubscription = false;

async function checkAuth() {
    try {
        const response = await fetch('/api/check-auth');
        const data = await response.json();
        if (!data.authenticated) { window.location.href = '/'; return; }
        userData = data;
        hasSubscription = data.subscription_active;
        document.getElementById('navUsername').textContent = data.username;
    } catch (error) { window.location.href = '/'; }
}

const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const tabPanels = document.querySelectorAll('.tab-panel');

sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    sidebarToggle.textContent = sidebar.classList.contains('open') ? '‚Äπ' : '‚Ä∫';
});

sidebarItems.forEach(item => {
    item.addEventListener('click', () => {
        const tabId = item.dataset.tab;
        sidebarItems.forEach(i => i.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));
        item.classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
        if (tabId === 'my-configs') loadMyConfigs();
        if (tabId === 'media') loadMediaConfigs();
    });
});

document.getElementById('searchBtn').addEventListener('click', searchConfigs);
document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchConfigs(); });

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
async function loadAllConfigs() {
    try {
        const response = await fetch('/api/configs/search?q=');
        const data = await response.json();
        const grid = document.getElementById('searchResults');
        const empty = document.getElementById('searchEmpty');
        if (data.configs && data.configs.length > 0) {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = data.configs.map(c => renderConfigCard(c, false)).join('');
        } else {
            empty.style.display = 'block';
            empty.querySelector('.empty-state-text').textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥–æ–≤';
            grid.style.display = 'none';
        }
    } catch (error) { console.error(error); }
}

async function searchConfigs() {
    const query = document.getElementById('searchInput').value.trim();
    try {
        const response = await fetch('/api/configs/search?q=' + encodeURIComponent(query));
        const data = await response.json();
        const grid = document.getElementById('searchResults');
        const empty = document.getElementById('searchEmpty');
        if (data.configs && data.configs.length > 0) {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = data.configs.map(c => renderConfigCard(c, false)).join('');
        } else {
            empty.style.display = 'block';
            empty.querySelector('.empty-state-text').textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            grid.style.display = 'none';
        }
    } catch (error) { console.error(error); }
}

function renderConfigCard(config, isOwner) {
    const canDownload = hasSubscription;
    return `
        <div class="config-card">
            <div class="config-card-header">
                <div class="config-name">${config.name}</div>
                <div class="config-badge ${config.private ? 'private' : ''}">${config.private ? 'Private' : 'Public'}</div>
            </div>
            <div class="config-author">by ${config.author}</div>
            <div class="config-desc">${config.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            <div class="config-actions">
                ${isOwner ? `<button class="config-btn delete" onclick="deleteConfig('${config.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                <button class="config-btn primary" onclick="downloadConfig('${config.id}')" ${!canDownload ? 'disabled' : ''}>‚¨á –°–∫–∞—á–∞—Ç—å</button>
            </div>
            ${!canDownload ? '<div class="no-sub-msg">–ù—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</div>' : ''}
        </div>
    `;
}
</script>

<script>
async function loadMyConfigs() {
    try {
        const response = await fetch('/api/configs/my');
        const data = await response.json();
        const grid = document.getElementById('myConfigsGrid');
        const empty = document.getElementById('myConfigsEmpty');
        if (data.configs && data.configs.length > 0) {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = data.configs.map(c => renderConfigCard(c, true)).join('');
        } else {
            empty.style.display = 'block';
            grid.style.display = 'none';
        }
    } catch (error) { console.error(error); }
}

async function downloadConfig(id) {
    if (!hasSubscription) { alert('–ù—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤'); return; }
    window.open('/api/configs/download/' + id, '_blank');
}

async function deleteConfig(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥?')) return;
    try {
        const response = await fetch('/api/configs/' + id, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) { alert('–ö–æ–Ω—Ñ–∏–≥ —É–¥–∞–ª—ë–Ω'); loadMyConfigs(); }
        else alert('–û—à–∏–±–∫–∞: ' + data.message);
    } catch (error) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
}

// Upload modal
const uploadModal = document.getElementById('uploadModal');
const uploadDropzone = document.getElementById('uploadDropzone');
const uploadForm = document.getElementById('uploadForm');
const uploadProgress = document.getElementById('uploadProgress');
const fileInput = document.getElementById('fileInput');
let selectedFile = null;

document.getElementById('uploadBtn').addEventListener('click', () => { uploadModal.classList.add('active'); resetUploadModal(); });
document.getElementById('uploadBtn2').addEventListener('click', () => { uploadModal.classList.add('active'); resetUploadModal(); });
document.getElementById('uploadSidebarBtn').addEventListener('click', () => { uploadModal.classList.add('active'); resetUploadModal(); });
document.getElementById('uploadModalClose').addEventListener('click', () => { uploadModal.classList.remove('active'); });
uploadModal.addEventListener('click', (e) => { if (e.target === uploadModal) uploadModal.classList.remove('active'); });

uploadDropzone.addEventListener('click', () => { if (!uploadForm.classList.contains('active')) fileInput.click(); });
uploadDropzone.addEventListener('dragover', (e) => { e.preventDefault(); uploadDropzone.classList.add('dragover'); });
uploadDropzone.addEventListener('dragleave', () => { uploadDropzone.classList.remove('dragover'); });
uploadDropzone.addEventListener('drop', (e) => { e.preventDefault(); uploadDropzone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });

function handleFile(file) {
    const allowedTypes = ['.json', '.cfg', '.txt', '.yaml', '.yml'];
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedTypes.includes(ext)) { alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç!\n–†–∞–∑—Ä–µ—à–µ–Ω—ã: ' + allowedTypes.join(', ')); return; }
    selectedFile = file;
    uploadProgress.classList.add('active');
    let progress = 0;
    const progressFill = document.getElementById('uploadProgressFill');
    const interval = setInterval(() => {
        progress += 10;
        progressFill.style.width = progress + '%';
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => { uploadDropzone.style.display = 'none'; uploadForm.classList.add('active'); document.getElementById('configName').value = file.name.replace(/\.[^/.]+$/, ''); }, 300);
        }
    }, 50);
}

function resetUploadModal() {
    uploadDropzone.style.display = 'flex';
    uploadForm.classList.remove('active');
    uploadProgress.classList.remove('active');
    document.getElementById('uploadProgressFill').style.width = '0%';
    document.getElementById('configName').value = '';
    document.getElementById('configDesc').value = '';
    document.getElementById('configPrivate').checked = false;
    selectedFile = null;
    fileInput.value = '';
}

document.getElementById('uploadCancel').addEventListener('click', resetUploadModal);
document.getElementById('uploadSubmit').addEventListener('click', async () => {
    const name = document.getElementById('configName').value.trim();
    const desc = document.getElementById('configDesc').value.trim();
    const isPrivate = document.getElementById('configPrivate').checked;
    if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    if (!selectedFile) { alert('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'); return; }
    
    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç
    const reader = new FileReader();
    reader.onload = async function(e) {
        const content = e.target.result;
        try {
            const response = await fetch('/api/configs/upload', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description: desc, content, private: isPrivate })
            });
            const data = await response.json();
            if (data.success) { alert('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω!'); uploadModal.classList.remove('active'); loadAllConfigs(); loadMyConfigs(); }
            else alert('–û—à–∏–±–∫–∞: ' + data.message);
        } catch (error) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
    };
    reader.readAsText(selectedFile);
});

checkAuth().then(() => loadAllConfigs());

// –ó–∞–≥—Ä—É–∑–∫–∞ media –∫–æ–Ω—Ñ–∏–≥–æ–≤
async function loadMediaConfigs() {
    try {
        const response = await fetch('/api/media-configs');
        const data = await response.json();
        const grid = document.getElementById('mediaConfigsGrid');
        const empty = document.getElementById('mediaEmpty');
        
        if (data.configs && data.configs.length > 0) {
            empty.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = data.configs.map(c => renderMediaConfigCard(c)).join('');
        } else {
            empty.querySelector('.empty-state-text').textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥–æ–≤ –æ—Ç Media';
            empty.style.display = 'block';
            grid.style.display = 'none';
        }
    } catch (error) {
        console.error(error);
    }
}

function renderMediaConfigCard(config) {
    const hasPrice = config.price && config.price > 0 && config.funpay_url;
    const promoDiscount = config.promo_code ? 5 : 0;
    const discountedPrice = config.price ? Math.round(config.price * (100 - promoDiscount) / 100) : 0;
    
    return `
        <div class="config-card" style="border-color: rgba(138, 43, 226, 0.3);">
            <div class="config-card-header">
                <div class="config-name">${config.name}</div>
                <div class="config-badge" style="background: rgba(138, 43, 226, 0.3); color: #9370db;">Media</div>
            </div>
            <div class="config-author" style="color: #9370db;">–æ—Ç ${config.author_name}</div>
            <div class="config-desc">${config.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            ${hasPrice ? `
                <div style="margin-bottom: 10px;">
                    <span style="font-size: 18px; font-weight: 600; color: #fff;">${config.price} ‚ÇΩ</span>
                    ${config.promo_code ? `<span style="font-size: 11px; color: #55ff55; margin-left: 8px;">–ü—Ä–æ–º–æ–∫–æ–¥: ${config.promo_code} (-5%)</span>` : ''}
                </div>
                <div class="config-actions">
                    <button class="config-btn primary" onclick="buyMediaConfig('${config.funpay_url}', '${config.name}', ${config.price})" style="background: rgba(138, 43, 226, 0.3); border-color: rgba(138, 43, 226, 0.4); color: #9370db;">üí≥ –ö—É–ø–∏—Ç—å</button>
                </div>
            ` : `
                <div style="color: #666; font-size: 12px;">–¶–µ–Ω–∞ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
            `}
        </div>
    `;
}

function buyMediaConfig(funpayUrl, name, price) {
    if (confirm('–ö—É–ø–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ "' + name + '" –∑–∞ ' + price + '‚ÇΩ –Ω–∞ FunPay?')) {
        window.open(funpayUrl, '_blank');
    }
}

// –ó–∞—â–∏—Ç–∞ –æ—Ç –ü–ö–ú –∏ DevTools
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
    }
});
</script>
</body>
</html>
